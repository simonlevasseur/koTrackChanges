// koTrackChanges 1.3.0 | (c) 2014 Simon LeVasseur |  http://www.opensource.org/licenses/mit-license
!function(a){"use strict";"function"==typeof require&&"object"==typeof exports&&"object"==typeof module?a(require("ko"),require("lodash"),exports):"function"==typeof define&&define.amd?define(["ko","lodash","exports"],a):a(ko,_,{})}(function(a,b,c){"use strict";var d=c;a.trackChanges=d;var e={};d.Group=function(c){var d=[];this.editables=a.observableArray([]),c&&(b.isArray(c)||a.isObservable(c)&&"push"in c||(c=[c]),a.utils.arrayForEach(a.unwrap(c),function(b){a.isObservable(b)&&(b.isDirty||b.extend({trackChanges:!0}),d.push(b))}),this.editables(d)),this.changes=a.computed(this.getChanges,this),this.isDirty=a.computed(this.getIsDirty,this)},d.Group.prototype={getChanges:function(){var b=[];return a.utils.arrayForEach(this.editables(),function(a){a.isDirty()&&b.push(a)}),b},getIsDirty:function(){return this.changes().length>0},refreshIsDirty:function(){a.utils.arrayForEach(this.editables(),function(a){a.refreshIsDirty()})},printChange:function(){a.utils.arrayForEach(this.changes(),function(a){a.printChange()})},commitAll:function(){a.utils.arrayForEach(this.editables(),function(a){a.commit()})},rollbackAll:function(){a.utils.arrayForEach(this.editables(),function(a){a.rollback()})},add:function(c){b.isArray(c)||a.isObservable(c)&&"push"in c||(c=[c]);var d=this.editables;a.utils.arrayForEach(a.unwrap(c),function(b){a.isObservable(b)&&(b.isDirty||b.extend({trackChanges:!0}),d.push(b))})},remove:function(c){b.isArray(c)||a.isObservable(c)&&"push"in c||(c=[c]),this.editables.removeAll(c)},dispose:function(){this.changes.dispose(),this.isDirty.dispose();for(var a in e)e.hasOwnProperty(a)&&e[a]===this&&delete e[a]}},d.getGroup=function(a){return e[a]},a.extenders.trackChanges=function(c,f){var g=a.observable();if(c.oldValue=a.observable(b.clone(c(),!0)),c.isDirty=a.computed(function(){return g(),!f.onlyIf||f.onlyIf&&f.onlyIf.call(c)?!b.isEqual(c(),c.oldValue()):!1}),c.refreshIsDirty=function(){g.valueHasMutated()},c.printChange=function(){console.log("Old: "+JSON.stringify(c.oldValue())+"\nNew: "+JSON.stringify(c()))},c.rollback=function(){this(b.clone(this.oldValue(),!0))},c.commit=function(a){a&&this(a),this.oldValue(b.clone(this(),!0))},b.isString(f)||b.isObject(f)&&b.isString(f.group)){var h=f.group||f;e[h]?e[h].editables.push(c):e[h]=new d.Group([c])}return c}});